buildscript {
    ext {
        buildToolsVersion = "35.0.0"
        minSdkVersion = 23
        compileSdkVersion = 35
        targetSdkVersion = 34  // Keep at 34 for now, can update later
        ndkVersion = "25.1.8937393"
        kotlinVersion = "2.0.0"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle:8.6.0")
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven {
            url("$rootDir/../node_modules/react-native/android")
        }
        maven {
            url("$rootDir/../node_modules/jsc-android/dist")
        }
    }
    
    // Exclude fabric sources when new architecture is disabled
    afterEvaluate { project ->
        if (project.hasProperty("android")) {
            project.android.sourceSets.all { sourceSet ->
                sourceSet.java {
                    exclude '**/fabric/**'
                }
                sourceSet.kotlin {
                    exclude '**/fabric/**'
                }
            }
            // Apply Kotlin compiler options to handle version compatibility
            if (project.hasProperty("kotlin")) {
                project.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                    kotlinOptions {
                        freeCompilerArgs += [
                            '-Xskip-metadata-version-check',
                            '-Xno-param-assertions',
                            '-Xno-call-assertions',
                            '-Xno-receiver-assertions',
                            '-Xno-optimized-callable-references'
                        ]
                        jvmTarget = '17'
                    }
                }
                
                // Special handling for gesture-handler to allow unsafe nullable calls
                if (project.name.contains('gesture-handler')) {
                    project.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
                        kotlinOptions {
                            freeCompilerArgs += [
                                '-Xno-optimized-callable-references',
                                '-Xskip-prerelease-check',
                                '-Xsuppress-version-warnings'
                            ]
                            jvmTarget = '17'
                        }
                    }
                    // Ensure React Native dependencies are available to gesture-handler
                    project.afterEvaluate {
                        if (project.hasProperty('android')) {
                            project.dependencies {
                                implementation('com.facebook.react:react-android')
                            }
                        }
                    }
                }
            }
        }
    }
}

apply plugin: "com.facebook.react.rootproject"
